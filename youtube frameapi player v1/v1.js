let player,playerReady=!1;const DEFAULT_IMAGE="https://i.giphy.com/3o7btMCltyDvSgF92E.webp",FALLBACK_VIDEO_ID="";let hideControlsTimeout,isIframeLoaded=!1,thumbnailUrl="",currentTime=0,isFirstPlay=!0,hasFirstPlayStarted=!1,isMuted=!1,currentQuality="Auto",isCCEnabled=!1,currentCCLang="",autoStopTime=null,autoStopInterval=null;const urlParams=new URLSearchParams(window.location.search),VIDEO_ID=urlParams.get("v")||"",SHARE_ID=urlParams.get("si")||"",START_TIME=parseInt(urlParams.get("t"))||0,LAPSE_PARAM=urlParams.get("lapse")||"";let timeLapses=[];function parseTimeLapses(e){if(!e)return[];return e.split(",").map(e=>e.trim()).map(e=>{const[t,...a]=e.split(/[- ]+/),[o,n]=t.split(":").map(Number);return{time:60*(o||0)+(n||0),label:a.join(" ").trim()}}).filter(e=>!isNaN(e.time)&&e.label)}function formatTime(e){const t=Math.floor(e/3600),a=Math.floor(e%3600/60),o=Math.floor(e%60);return t>0?`${t}:${a.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`:`${a}:${o.toString().padStart(2,"0")}`}function showError(e){document.getElementById("errorMessage").textContent=e,document.getElementById("errorMessage").style.display="block",document.getElementById("statusMessage").textContent=""}function showStatus(e){const t=document.getElementById("statusMessage");document.getElementById("controls");t.textContent=e,hasFirstPlayStarted?(t.classList.add("visible"),clearTimeout(hideControlsTimeout),hideControlsTimeout=setTimeout(()=>{t.classList.remove("visible")},5e3)):t.classList.add("visible")}function showControls(){if(!hasFirstPlayStarted)return;const e=document.getElementById("controls"),t=document.getElementById("videoInfo"),a=document.getElementById("statusMessage");e.classList.add("visible"),t.classList.add("visible"),a.classList.add("visible"),clearTimeout(hideControlsTimeout),hideControlsTimeout=setTimeout(()=>{e.classList.remove("visible"),t.classList.remove("visible"),a.classList.remove("visible")},5e3)}async function tryLoadImage(e){return new Promise((t,a)=>{const o=new Image;o.onload=()=>t(e),o.onerror=()=>a(new Error(`Failed to load image: ${e}`)),o.src=e})}async function fetchThumbnail(){if(!VIDEO_ID)return thumbnailUrl=DEFAULT_IMAGE,document.getElementById("videoTitle").textContent="No video selected",document.getElementById("videoAuthor").textContent="Unknown author",showThumbnail(),void showStatus("No video ID provided. use ?v=(id)");try{const e=`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${VIDEO_ID}${SHARE_ID?"&si="+SHARE_ID:""}&format=json`,t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const a=await t.json();if(!a.thumbnail_url)throw new Error("Thumbnail URL not found in API response");{document.querySelector("link").href=a.thumbnail_url.replace("hqdefault","default");let e=a.thumbnail_url.replace("hqdefault","maxresdefault");try{await tryLoadImage(e),thumbnailUrl=e}catch(e){thumbnailUrl=a.thumbnail_url}const t=a.title||"Untitled Video",o=/#[\w]+/g,n=t.match(o)||[],l=t.replace(o,"").trim()||"Untitled Video";if(document.getElementById("videoTitle").textContent=l,document.querySelector("title").innerHTML=l,n.length>0){const e=document.createElement("div");e.className="hashtags",e.innerHTML=n.map(e=>`<span>${e.replace('#', '')}</span>`).join(""),document.getElementById("videoInfo").appendChild(e),document.querySelectorAll(".hashtags span").forEach(e=>{e.addEventListener("click",()=>{const t=e.textContent;window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(t)}`,"_blank")})})}document.getElementById("videoAuthor").textContent=a.author_name||"Unknown author",showThumbnail(),showStatus("Thumbnail loaded. Loading video player..."),loadIframe(VIDEO_ID,SHARE_ID)}}catch(e){showError("Failed to load thumbnail: "+e.message),document.getElementById("videoTitle").textContent="Error loading video",document.getElementById("videoAuthor").textContent="Unknown author",loadIframe(VIDEO_ID,SHARE_ID)}}function showThumbnail(){const e=document.getElementById("videoWrapper");let t=document.querySelector(".thumbnail");t||(t=document.createElement("img"),t.src=thumbnailUrl,t.className="thumbnail",t.alt="Video thumbnail",e.appendChild(t)),t.classList.remove("hidden","first-play","pause-transition");const a=document.getElementById("player");a&&a.classList.remove("visible","first-play","pause-transition"),t.classList.add("pause-transition"),a&&a.classList.add("pause-transition");const o=document.getElementById("bigPlayButton");o.style.display=isFirstPlay&&!hasFirstPlayStarted?"flex":"none",setTimeout(()=>{t.classList.remove("pause-transition"),a&&a.classList.remove("pause-transition"),isFirstPlay&&(t.classList.add("first-play"),a&&a.classList.add("first-play"))},1),showStatus("Thumbnail displayed. Waiting for first play...")}document.getElementById("errorMessage").style.display="none";const tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api",tag.onerror=()=>{showError("Failed to load YouTube IFrame API. Check network, ad blockers, or browser settings.")},tag.onload=()=>{showStatus("YouTube IFrame API loaded."),fetchThumbnail()};const firstScriptTag=document.getElementsByTagName("script")[0];function onYouTubeIframeAPIReady(){if(VIDEO_ID)try{player=new YT.Player("player",{events:{onReady:onPlayerReady,onError:onPlayerError,onStateChange:onPlayerStateChange,onPlaybackQualityChange:onPlaybackQualityChange},playerVars:{controls:0,cc_load_policy:0,cc_lang_pref:"en",start:START_TIME}}),showStatus("Player initialized. Waiting for readiness...")}catch(e){showError("Failed to initialize YouTube player: "+e.message),tryFallbackVideo()}}function loadIframe(e,t=""){if(isIframeLoaded||!e)return;isIframeLoaded=!0;const a=document.getElementById("videoWrapper"),o=document.createElement("iframe");o.id="player",o.src=`https://www.youtube.com/embed/${e}?enablejsapi=1&controls=0&cc_load_policy=0${t?"&si="+t:""}${START_TIME?"&start="+START_TIME:""}`,o.frameBorder="0",o.allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",o.allowFullscreen=!0,isFirstPlay&&o.classList.add("first-play"),a.appendChild(o),onYouTubeIframeAPIReady()}function tryFallbackVideo(){showStatus("Attempting to load fallback video...");try{const e=document.getElementById("videoWrapper");document.querySelector(".thumbnail")?.classList.add("hidden");const t=document.getElementById("player");t&&t.remove();const a=document.createElement("iframe");a.id="player",a.src=`https://www.youtube.com/embed/?enablejsapi=1&controls=0&cc_load_policy=0${SHARE_ID?"&si="+SHARE_ID:""}${START_TIME?"&start="+START_TIME:""}`,a.frameBorder="0",a.allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",a.allowFullscreen=!0,isFirstPlay&&a.classList.add("first-play"),e.appendChild(a),isIframeLoaded=!0,currentTime=START_TIME,onYouTubeIframeAPIReady(),showStatus("Fallback player initialized. Waiting for readiness...")}catch(e){showError("Failed to initialize fallback player: "+e.message),showThumbnail()}}function onPlayerReady(e){playerReady=!0,showStatus("Player is ready. Click Play to start video: "+player.getVideoData().video_id),player.seekTo(currentTime||START_TIME,!0),isMuted&&player.mute(),updateQualityDisplay(),updateCCStatus(),updateAutoStopDisplay();const t=document.getElementById("player");t&&(t.classList.remove("visible"),document.querySelector(".thumbnail")?.classList.remove("hidden")),updateSeekBar(),renderTimeLapseMarkers()}function onPlaybackQualityChange(e){currentQuality={small:"240p",medium:"360p",large:"480p",hd720:"720p",hd1080:"1080p",highres:"High Res"}[e.data]||"Auto",updateQualityDisplay()}function updateQualityDisplay(){document.getElementById("qualityDisplay").textContent=currentQuality}function updateCCStatus(){const e=document.getElementById("ccBtn");isCCEnabled?(e.textContent=`CC (${currentCCLang||"en"})`,e.title="Disable Closed Captions"):(e.textContent="CC",e.title="Enable Closed Captions")}function updateAutoStopDisplay(){const e=document.getElementById("autoStopBtn");if(null===autoStopTime)e.textContent="Timer",e.title="Set Auto-Stop Timer";else{const t="end"===autoStopTime?"End":`${autoStopTime}m`;e.textContent=`Timer (${t})`,e.title="Change Auto-Stop Timer"}}function startAutoStopTimer(e){if(autoStopInterval&&clearInterval(autoStopInterval),"end"===e)return autoStopTime="end",updateAutoStopDisplay(),void showStatus("Auto-stop set to end of video");const t=60*e;let a=Date.now();autoStopTime=e,updateAutoStopDisplay(),autoStopInterval=setInterval(()=>{if(!playerReady||!player||player.getPlayerState()!==YT.PlayerState.PLAYING)return;(Date.now()-a)/1e3>=t&&(player.pauseVideo(),clearInterval(autoStopInterval),autoStopInterval=null,autoStopTime=null,updateAutoStopDisplay(),showStatus("Auto-stop timer reached. Video paused."))},1e3),showStatus(`Auto-stop timer set for ${e} minutes`)}function onPlayerError(e){showError("Player error: "+({2:"Invalid video ID",5:"HTML5 player error",100:"Video not found",101:"Video not allowed in embedded player",150:"Video not allowed in embedded player"}[e.data]||"Unknown error (code: "+e.data+")")),player&&player.getVideoData&&player.getVideoData().video_id===VIDEO_ID?(showStatus("Primary video failed. Trying fallback video..."),tryFallbackVideo()):showThumbnail()}function onPlayerStateChange(e){const t=document.getElementById("togglePlayBtn"),a=document.getElementById("videoInfo"),o=document.getElementById("controls"),n=document.getElementById("statusMessage");if(e.data===YT.PlayerState.PLAYING){showStatus("Video is playing: "+player.getVideoData().video_id);const e=document.querySelector(".thumbnail"),l=document.getElementById("player");e&&(e.classList.remove("pause-transition"),e.classList.add("hidden")),l&&(l.classList.remove("pause-transition"),l.classList.add("visible"),isFirstPlay&&(isFirstPlay=!1,hasFirstPlayStarted=!0,o.classList.add("visible"),a.classList.add("visible"),n.classList.add("visible"),document.getElementById("bigPlayButton").style.display="none",l.style.pointerEvents="none",l.style.userSelect="none",l.setAttribute("tabindex","-1"),setTimeout(()=>{l.classList.remove("first-play"),e?.classList.remove("first-play")},12e3))),t.innerHTML='<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6zM14 4h4v16h-4z"/></svg>',t.title="Pause",showControls(),updateSeekBar()}else e.data===YT.PlayerState.PAUSED?(currentTime=player.getCurrentTime(),showStatus("Video is paused. Displaying thumbnail..."),showThumbnail(),t.innerHTML='<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',t.title="Play",showControls()):e.data===YT.PlayerState.ENDED&&(currentTime=0,showStatus("Video has ended. Displaying thumbnail..."),showThumbnail(),player.seekTo(0,!0),t.innerHTML='<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',t.title="Play",clearInterval(autoStopInterval),autoStopInterval=null,autoStopTime=null,updateAutoStopDisplay(),showControls())}function updateSeekBar(){if(!playerReady||!player||"function"!=typeof player.getCurrentTime)return;const e=player.getCurrentTime(),t=player.getDuration();if(t>0){const a=e/t*100;document.getElementById("seekBarProgress").style.width=`${a}%`,document.getElementById("timeDisplay").textContent=`${formatTime(e)} / ${formatTime(t)}`,"end"===autoStopTime&&e>=t-1&&(player.pauseVideo(),autoStopTime=null,updateAutoStopDisplay(),showStatus("Auto-stop reached at end of video."))}player&&playerReady&&player.getPlayerState()===YT.PlayerState.PLAYING&&requestAnimationFrame(updateSeekBar)}function renderTimeLapseMarkers(){const e=document.getElementById("seekBar");if(document.querySelectorAll(".time-lapse-marker").forEach(e=>e.remove()),!playerReady||!player||!timeLapses.length)return;const t=player.getDuration();t<=0||timeLapses.forEach(a=>{const o=document.createElement("div");o.className="time-lapse-marker";const n=a.time/t*100;o.style.left=`${Math.min(n,100)}%`,o.setAttribute("data-label",a.label),o.addEventListener("click",()=>{player&&"function"==typeof player.seekTo&&(player.seekTo(a.time,!0),player.getPlayerState()!==YT.PlayerState.PLAYING&&player.playVideo(),showStatus(`Jumped to: ${a.label} (${formatTime(a.time)})`),showControls())}),e.appendChild(o)})}function initiateDownload(){if(!VIDEO_ID)return void showError("No video ID provided for download");const e=`https://cobalt.meowing.de/?u=https://www.youtube.com/watch?v=${VIDEO_ID}${SHARE_ID?"&si="+SHARE_ID:""}&vCodec=h264&vQuality=720`;window.open(e,"_blank"),showStatus("Initiating MP4 download..."),showControls()}firstScriptTag.parentNode.insertBefore(tag,firstScriptTag),document.getElementById("togglePlayBtn").addEventListener("click",()=>{if(!playerReady||!player||"function"!=typeof player.playVideo||"function"!=typeof player.getPlayerState)return void showError("Player is not ready. Please try again.");const e=document.querySelector(".thumbnail"),t=document.getElementById("player"),a=document.getElementById("togglePlayBtn");document.getElementById("videoInfo"),document.getElementById("controls"),document.getElementById("statusMessage");player.getPlayerState()===YT.PlayerState.PLAYING?(currentTime=player.getCurrentTime(),player.pauseVideo(),showThumbnail(),a.innerHTML='<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',a.title="Play",showControls()):(isFirstPlay?(e?.classList.add("first-play"),t&&t.classList.add("first-play"),t&&(t.style.pointerEvents="none",t.style.userSelect="none",t.setAttribute("tabindex","-1")),setTimeout(()=>{player.seekTo(currentTime||START_TIME,!0),player.playVideo()},1e4)):(e?.classList.remove("first-play","pause-transition"),t&&t.classList.remove("first-play","pause-transition"),player.seekTo(currentTime||START_TIME,!0),player.playVideo()),e?.classList.add("hidden"),t&&t.classList.add("visible"),a.innerHTML='<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6zM14 4h4v16h-4z"/></svg>',a.title="Pause",showControls())}),document.getElementById("muteBtn").addEventListener("click",()=>{playerReady&&player&&"function"==typeof player.mute?(isMuted?(player.unMute(),document.getElementById("muteBtn").innerHTML='<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4l-5 5H3zm13.5 3c0-1.77-.77-3.36-2-4.47v8.94c1.23-1.11 2-2.7 2-4.47zM19 12c0 2.21-1.03 4.19-2.65 5.5l1.41 1.41C20.02 16.97 21 14.61 21 12s-.98-4.97-2.24-6.91l-1.41 1.41C18.97 7.81 19 9.79 19 12z"/></svg>',document.getElementById("muteBtn").title="Mute",showStatus("Video unmuted")):(player.mute(),document.getElementById("muteBtn").innerHTML='<svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4l-5 5H3zm13.11 3.47l-1.42-1.42C15.61 10.13 16 9.13 16"></path></svg>',document.getElementById("muteBtn").title="Unmute",showStatus("Video muted")),isMuted=!isMuted,showControls()):showError("Player is not ready. Please try again.")}),document.getElementById("seekBar").addEventListener("click",e=>{if(!playerReady||!player||"function"!=typeof player.seekTo)return;const t=document.getElementById("seekBar").getBoundingClientRect(),a=(e.clientX-t.left)/t.width*player.getDuration();player.seekTo(a,!0),currentTime=a,player.getPlayerState()!==YT.PlayerState.PLAYING&&player.playVideo(),showControls()}),document.getElementById("seekBar").addEventListener("touchstart",e=>{if(e.preventDefault(),!playerReady||!player||"function"!=typeof player.seekTo)return;const t=document.getElementById("seekBar").getBoundingClientRect(),a=(e.touches[0].clientX-t.left)/t.width*player.getDuration();player.seekTo(a,!0),currentTime=a,player.getPlayerState()!==YT.PlayerState.PLAYING&&player.playVideo(),showControls()},{passive:!1}),document.getElementById("fullscreenBtn").addEventListener("click",()=>{const e=document.getElementById("videoContainer");document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen(),showControls()}),document.getElementById("ccBtn").addEventListener("click",()=>{playerReady&&player&&"function"==typeof player.loadModule?(isCCEnabled=!isCCEnabled,isCCEnabled?(player.loadModule("captions"),player.setOption("captions","track",{languageCode:currentCCLang||"en"})):player.unloadModule("captions"),updateCCStatus(),showControls()):showError("Player is not ready. Please try again.")}),document.getElementById("ccOffBtn").addEventListener("click",()=>{playerReady&&player&&(isCCEnabled=!1,player.unloadModule("captions"),currentCCLang="",updateCCStatus(),showControls())}),document.getElementById("ccEnBtn").addEventListener("click",()=>{playerReady&&player&&(isCCEnabled=!0,currentCCLang="en",player.loadModule("captions"),player.setOption("captions","track",{languageCode:"en"}),updateCCStatus(),showControls())}),document.getElementById("ccThBtn").addEventListener("click",()=>{playerReady&&player&&(isCCEnabled=!0,currentCCLang="th",player.loadModule("captions"),player.setOption("captions","track",{languageCode:"th"}),updateCCStatus(),showControls())}),document.getElementById("autoStopOffBtn").addEventListener("click",()=>{playerReady&&player&&(clearInterval(autoStopInterval),autoStopInterval=null,autoStopTime=null,updateAutoStopDisplay(),showStatus("Auto-stop timer disabled"),showControls())}),document.getElementById("autoStop1MinBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer(1),showControls())}),document.getElementById("autoStop5MinBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer(5),showControls())}),document.getElementById("autoStop10MinBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer(10),showControls())}),document.getElementById("autoStop20MinBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer(20),showControls())}),document.getElementById("autoStop30MinBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer(30),showControls())}),document.getElementById("autoStop40MinBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer(40),showControls())}),document.getElementById("autoStop50MinBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer(50),showControls())}),document.getElementById("autoStop60MinBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer(60),showControls())}),document.getElementById("autoStopEndBtn").addEventListener("click",()=>{playerReady&&player&&(startAutoStopTimer("end"),showControls())}),document.getElementById("downloadBtn").addEventListener("click",initiateDownload),document.getElementById("videoContainer").addEventListener("mousemove",showControls),document.getElementById("videoContainer").addEventListener("touchstart",showControls,{passive:!0}),window.addEventListener("orientationchange",()=>{setTimeout(()=>{const e=document.getElementById("player"),t=document.querySelector(".thumbnail");e&&(e.style.width=window.innerWidth>window.innerHeight?"100vw":"100vh",e.style.height=window.innerWidth>window.innerHeight?"100vh":"100vw"),t&&(t.style.width=window.innerWidth>window.innerHeight?"100vw":"100vh",t.style.height=window.innerWidth>window.innerHeight?"100vh":"100vw"),renderTimeLapseMarkers()},100)}),timeLapses=parseTimeLapses(LAPSE_PARAM),timeLapses.length&&showStatus("Time lapses loaded: "+timeLapses.map(e=>`${e.label} (${formatTime(e.time)})`).join(", "));